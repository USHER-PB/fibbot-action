name: Fibonacci Calculation and PR Comment

on:
  pull_request:
    types: [opened, synchronize, edited]

# Grant permissions to the GITHUB_TOKEN
permissions:
  pull-requests: write
  contents: read

jobs:
  calculate-fibonacci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          components: rustfmt, clippy
          profile: minimal

      - name: Install jq (for parsing JSON)
        run: sudo apt-get install -y jq


      - name: Use custom action
        uses: ./  # Path to the directory containing action.yml
        with:
          enable_fibbot: "true"
          max_threshold: "100"

      - name: Build and run Rust program
        id: fibonacci
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
         
      - name: Set GITHUB_OWNER
        run: |
         echo "GITHUB_OWNER=${{ github.repository_owner }}" >> $GITHUB_ENV
      
          INPUT_ENABLE_FIB: ${{ github.event.inputs.enable_fibbot || 'true' }}
          INPUT_MAX_THRESHOLD: ${{ github.event.inputs.max_threshold || '100' }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # Build and run the Rust program, capturing the output
          FIBONACCI_RESULT=$(cargo run -q)
          echo "FIBONACCI_RESULT=$FIBONACCI_RESULT" >> $GITHUB_ENV

          # Extract PR number from the GitHub event payload
          PR_NUMBER=$(jq --raw-output .pull_request.number "$GITHUB_EVENT_PATH")
          echo "PR_NUMBER=${PR_NUMBER}" >> $GITHUB_ENV

      - name: Post comment on PR
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { FIBONACCI_RESULT, PR_NUMBER } = process.env;
            if (!PR_NUMBER) {
              console.error("PR_NUMBER is not set. Cannot post comment.");
              process.exit(1);
            }
            github.rest.issues.createComment({
              issue_number: PR_NUMBER,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `Here is the Fibonacci sequence: ${FIBONACCI_RESULT || "No result"}`
            });


     
      - name: Debug environment variables
        run: |
          echo "GITHUB_TOKEN: $GITHUB_TOKEN"
          echo "GITHUB_EVENT_PATH: $GITHUB_EVENT_PATH"
          echo "PR_NUMBER: $PR_NUMBER"
          echo "FIBONACCI_RESULT: $FIBONACCI_RESULT"
          echo "INPUT_ENABLE_FIB: $INPUT_ENABLE_FIB"
          echo "INPUT_MAX_THRESHOLD: $INPUT_MAX_THRESHOLD"

      - name: Use this variables
        run: |
          echo "enable_fibbot: ${{ github.event.inputs.enable_fibbot || 'true' }}"
          echo "max_threshold: ${{ github.event.inputs.max_threshold || '100' }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
         

    