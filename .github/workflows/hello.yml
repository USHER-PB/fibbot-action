name: Fibonacci Calculation and PR Comment

on:
  pull_request:
    types: [opened, synchronize, edited]

# Grant permissions to the GITHUB_TOKEN
permissions:
  pull-requests: write
  contents: read

jobs:
  calculate-fibonacci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Install jq (for parsing JSON)
        run: sudo apt-get install -y jq

      - name: Use custom action
        uses: ./  # Path to the directory containing action.yml
        with:
          enable_fibbot: "true"
          max_threshold: "100"


      - name: Build and run Rust program
        id: fibonacci
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Ensure GITHUB_TOKEN is set
          INPUT_ENABLE_FIB: ${{ inputs.enable_fibbot }}  # Passed from action.yml
          INPUT_MAX_THRESHOLD: ${{ inputs.max_threshold }}  # Passed from action.yml
        run: |
          # Build and run the Rust program, capturing the output
          FIBONACCI_RESULT=$(cargo run -q)
          echo "FIBONACCI_RESULT=$FIBONACCI_RESULT" >> $GITHUB_ENV

          # Extract PR number from the GitHub event payload
          PR_NUMBER=$(jq --raw-output .pull_request.number "$GITHUB_EVENT_PATH")
          echo "PR_NUMBER=${PR_NUMBER}" >> $GITHUB_ENV

      - name: Debug environment variables
        run: |
          echo "GITHUB_TOKEN: $GITHUB_TOKEN"
          echo "GITHUB_EVENT_PATH: $GITHUB_EVENT_PATH"
          echo "PR_NUMBER: $PR_NUMBER"
          echo "FIBONACCI_RESULT: $FIBONACCI_RESULT"
          echo "INPUT_ENABLE_FIB: $INPUT_ENABLE_FIB"
          echo "INPUT_MAX_THRESHOLD: $INPUT_MAX_THRESHOLD"
      - name: Use this variables 
        run:
        with:
        args:
          - enable_fibbot: "true"
          - max_threshold: "100"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # - name: Post comment on PR
      #   uses: actions/github-script@v6
      #   with:
      #     github-token: ${{ secrets.GITHUB_TOKEN }}  # Pass GITHUB_TOKEN to github-script
      #     script: |
      #       const { FIBONACCI_RESULT, PR_NUMBER } = process.env;
      #       if (!PR_NUMBER) {
      #         console.error("PR_NUMBER is not set. Cannot post comment.");
      #         process.exit(1);
      #       }
      #       github.rest.issues.createComment({
      #         issue_number: PR_NUMBER,  # Use the PR_NUMBER environment variable
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         body: `Here is the Fibonacci sequence: ${FIBONACCI_RESULT || "No result"}`
      #       });
 